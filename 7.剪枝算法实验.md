## \section{基于动态拓扑的剪枝算法对联邦训练的影响}

\label{sec:exp-pruning}

在基于动态拓扑的剪枝算法中，有三个超参数的设置是值得讨论的，分别是联邦模型的整体剪枝率$\alpha$、初始的动态调整比例系数$p^0$和动态调整的间隔轮数$\Delta T$。当$\alpha$设置为0时，整个联邦学习的框架退化为不剪枝的情况，因此，\ref{subsec:exp-pruning-1}节将讨论不同数据划分情况下，是否引入剪枝技术以及不同的$\alpha$对联邦训练的影响。此外，当$p^0$设置为0时，由等式\ref{eq:f-decay}可知，训练过程中的动态调整比例系数$p^t$始终为0，因此，\ref{subsec:exp-pruning-2}节将讨论是否引入动态拓扑以及不同的$p^0$对联邦训练的影响，此外，本节还会对动态调整间隔轮数$\Delta T$的设置进行讨论。



### \subsection{整体剪枝率$\alpha$的影响}

\label{subsec:exp-pruning-1}

本节研究样本标签分布为独立同分布和非独立同分布（$\beta=0.5$和$\beta=0.1$）时，不同的整体剪枝率$\alpha$对联邦训练的影响。当$\alpha=0$时，表示模型在训练过程中始终保持完整。因为本节主要关注的超参数是整体剪枝率$\alpha$，因此其他的超参数将会被固定，例如动态调整初始比例系数$p^0=0$，动态调整间隔轮数$\Delta T=\infty$，聚合算法权衡系数$\gamma=1$，即训练过程中不会对网络拓扑进行调整。图\ref{fig:fig3}展示了不同数据划分情况下，联邦模型的测试准确率与整体剪枝率$\alpha$的关系。

首先，在剪枝率$\alpha$相同的情况下，样本标签非独立同分布会影响联邦模型的训练效果，使得联邦模型的测试准确率下降，且非独立同分布的程度越高，测试准确率就越低。其次，对于样本标签分布相对平衡（独立同分布和$\beta=0.5$的狄利克雷分布）的情况，剪枝率为0到0.8的测试准确率维持在一个较高的水准，这说明在样本标签分布相对平衡的情况下，较大范围的剪枝不会对联邦模型的精度造成太大的影响。但是，剪枝率大于0.8时，测试准确率开始下降，这说明太大范围的剪枝已经严重破坏了网络的结构，使得联邦模型的学习性能显著下降。最后，对于样本标签非独立同分布的程度较高（$\beta=0.1$的狄利克雷分布）的情况，合适的剪枝率相比不剪枝时更能提高联邦模型的精度，并在$\alpha=0.5$左右达到测试准确率的峰值。本文认为，出现该现象的主要原因是合适的剪枝率有助于降低客户端之间模型参数或梯度更新的差异，使得各个客户端的更新方向更为一致，从而提升联邦模型的训练效果。

图\ref{fig:fig4-1}和图\ref{fig:fig4-2}分别展示了不同数据划分和不同剪枝率的训练情况。其中，图\ref{fig:fig4-1}的使用平均FLOPs作为横坐标，反应了客户端在训练模型过程中产生的平均计算量，图\ref{fig:fig4-2}使用平均上传开销作为横坐标，反应了客户端将训练好的模型上传给服务器产生的通信开销。通过这两张图可以发现，对于样本标签非独立同分布的程度较高（$\beta=0.1$的狄利克雷分布）的情况，整体剪枝率$\alpha$越大，则测试准确率的变化更加稳定，达到收敛状态所需要的通信和计算资源更少。

适当剪枝能让曲线更加平稳

iid从0.5开始越大越慢收敛？

#### 超参数

指标：通信轮次、上传、FLOPs

数据分布：iid 0.1 0.5

剪枝算法：是

剪枝率：0.0 0.4 0.5 0.6 0.7 0.8 0.85 0.9

动态剪枝：否

剪枝间隔：0

初始比例：0

聚合算法：是

权衡系数：1

统计指标：FLOPs、上传开销

收敛速度：0.9最快

曲线稳定：0.0最稳定

最终精度：tradeoff

#### 实验结果

| 剪枝率     | iid        | $\beta=0.5$ | $\beta=0.1$   |
| ---------- | ---------- | ----------- | ------------- |
| 0.3（0.0） | 0.6544 a+b | 0.61535 a   | 0.43656 b+c   |
| 0.4        | 0.65676 a  | 0.61896 a   | 0.458429998 b |
| 0.5        | 0.66816 a  | 0.61985 a   | 0.52653 a     |
| 0.6        | 0.64791 a  | 0.62733 a   | 0.42421 a     |
| 0.7        | 0.64565 a  | 0.61294 b   | 0.427035 b    |
| 0.8        | 0.65044 a  | 0.61669 a   | 0.44003 b     |
| 0.85       | 0.62724 a  | 0.59796 a   | 0.36106 b     |
| 0.9        | 0.597009 a | 0.53684 a   | 0.33501 b     |

| 剪枝率  | iid  | $\beta=0.5$ | $\beta=0.1$                     | 加噪 |
| ------- | ---- | ----------- | ------------------------------- | ---- |
| **0.4** |      |             | 0.42096 x **0.46199** y         |      |
| **0.5** |      |             | **0.4472** x 0.4159 y 0.43205 c |      |
| **0.6** |      |             | **0.41565** x 0.40632 y         |      |
| **0.7** |      |             | **0.44516** x 0.42078 y         |      |
| 0.8     |      |             | 0.38508 x **0.39313** y         |      |
| 0.85    |      |             | **0.34976** x 0.34931 y         |      |
| 0.9     |      |             | **0.37152** x 0.37096 y         |      |
| 0.95    |      |             | **0.324517** x                  |      |

|      | 1    | 4    | 7    | 10   | 20   | 40   | $\infty$ |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | -------- |
| 0.5  | 0.43 | 0.44 | 0.45 | 0.46 | 0.45 | 0.44 | 0.437366 |
| 0.7  | 0.39 | 0.40 | 0.42 | 0.44 | 0.42 | 0.40 | 0.397884 |
| 0.9  | 0.36 | 0.36 | 0.39 | 0.42 | 0.39 | 0.36 | 0.354562 |

|      | 0.0      | 0.2  | 0.4  | 0.6  | 0.8  |
| ---- | -------- | ---- | ---- | ---- | ---- |
| 0.5  | 0.437366 | 0.44 | 0.46 | 0.46 | 0.45 |
| 0.7  | 0.397884 | 0.40 | 0.42 | 0.44 | 0.42 |
| 0.9  | 0.354562 | 0.36 | 0.39 | 0.42 | 0.39 |





| 剪枝率 | iid         | $\beta=0.5$     | $\beta=0.1$       | 不平衡噪声 |
| ------ | ----------- | --------------- | ----------------- | ---------- |
| 0.0    |             |                 |                   | 0.47538    |
| 0.1    |             |                 |                   | 0.482795   |
| 0.2    |             |                 |                   | 0.48274    |
| 0.3    |             | 0.62996 81      |                   | 0.495345   |
| 0.4    | 0.65627     |                 | 0.429368          | 0.50826    |
| 0.5    |             | 0.62872 103     | 0.437366          | 0.50702    |
| 0.6    | 0.66192     | 0.602213 25     | 0.406688          | 0.505385   |
| 0.7    |             | **0.60322**     | 0.397884          | 0.508045   |
| 0.75   |             | 0.61217 119     |                   |            |
| 0.8    | 0.63904     | **0.60162** 176 | 0.399459          | 0.532715   |
| 0.85   | **0.62232** | **0.58063** 171 | **0.44**          | x          |
| 0.9    | 0.61661     | **0.573965**    | 0.439198 0.354562 | x          |
| 0.95   | x           | **0.54434**     | x                 | x          |

diri05

|          | 0.0  | 0.1          | 0.3                  | 0.5                | 0.7                 | 0.9     |
| -------- | ---- | ------------ | -------------------- | ------------------ | ------------------- | ------- |
| 1        | 0.56 | 0.59522/0.58 | 0.5838               | 0.57029            | 0.5511              | 0.50522 |
| 3        | 0.56 | 0.59864/0.59 | 0.59041              | 0.58165            | 0.56907             | 0.54114 |
| 6        | 0.56 | 0.60371/0.59 | **0.58435** 0.593755 | 0.58267            | 0.5783              | 0.5636  |
| 15       | 0.56 | 0.58534      | 0.59823              | **0.5776** 0.59004 | 0.59081/0.58        | 0.58638 |
| 30       | 0.56 | 0.58274      | 0.58466              | 0.58845            | **0.57968** 0.58978 | 0.59008 |
| $\infty$ | 0.56 | 0.56         | 0.56                 | 0.56               | 0.56                | 0.56    |

diri05+agg 0.7

|          | 0.0  | 0.1  | 0.3  | 0.5  | 0.7  | 0.9  |
| -------- | ---- | ---- | ---- | ---- | ---- | ---- |
| 1        | 0.57 |      |      |      |      |      |
| 3        | 0.57 | 0.59 | 0.59 |      |      |      |
| 6        | 0.57 | 0.60 |      |      |      |      |
| 15       | 0.57 |      | 0.58 |      |      |      |
| 30       | 0.57 |      |      |      |      |      |
| $\infty$ | 0.57 | 0.57 | 0.57 | 0.57 | 0.57 | 0.57 |

噪声

|          | 0.0      | 0.1      | 0.3      | 0.5      | 0.7      | 0.9      |
| -------- | -------- | -------- | -------- | -------- | -------- | -------- |
| 1        | 0.532715 |          |          |          |          |          |
| 3        | 0.532715 |          |          |          |          |          |
| 6        | 0.532715 | 0.53     |          |          |          |          |
| 15       | 0.532715 | 0.51     | 0.52     | 0.50     |          |          |
| 30       | 0.532715 | 0.51     | 0.51     | 0.51     |          |          |
| $\infty$ | 0.532715 | 0.532715 | 0.532715 | 0.532715 | 0.532715 | 0.532715 |

噪声+agg

|          | 0.0  | 0.1      | 0.3      | 0.5      | 0.7  | 0.9  |
| -------- | ---- | -------- | -------- | -------- | ---- | ---- |
| 1        | 0.57 | 0.57     |          |          |      |      |
| 3        | 0.57 | 0.57     | 0.55     |          |      |      |
| 6        | 0.57 | **0.58** | 0.56     | 0.56     |      |      |
| 15       | 0.57 | **0.58** | **0.58** | **0.58** | 0.55 |      |
| 30       | 0.57 | **0.58** | **0.57** | **0.57** |      |      |
| $\infty$ | 0.57 | 0.57     | 0.57     | 0.57     | 0.57 | 0.57 |

python fedprune.py --grad-agg --tradeoff 0.7 --need-readjust --readjustment-ratio 0.3 --rounds-between-readjustments 6 --outfile cifar10_diri_05_agg_07_read_036_a.csv --device

python fedprune.py --grad-agg --tradeoff 0.7 --need-readjust --readjustment-ratio 0.5 --rounds-between-readjustments 6 --outfile cifar10_diri_05_agg_07_read_056_a.csv --device

python fedprune.py --grad-agg --tradeoff 0.7 --need-readjust --readjustment-ratio 0.5 --rounds-between-readjustments 15 --outfile cifar10_diri_05_agg_07_read_0515_a.csv --device

python fedprune.py --grad-agg --tradeoff 0.7 --need-readjust --readjustment-ratio 0.5 --rounds-between-readjustments 30 --outfile cifar10_diri_05_agg_07_read_0530_a.csv --device

python fedprune.py --grad-agg --tradeoff 0.7 --need-readjust --readjustment-ratio 0.7 --rounds-between-readjustments 15 --outfile cifar10_diri_05_agg_07_read_0715_a.csv --device

python fedprune.py --grad-agg --tradeoff 0.7 --need-readjust --readjustment-ratio 0.7 --rounds-between-readjustments 30 --outfile cifar10_diri_05_agg_07_read_0730_a.csv --device



| 实验组编号  | 剪枝方式 | 聚合方式 | $\alpha$ | $p^0$ | $\Delta T$ | $\gamma^0$ |
| ----------- | -------- | -------- | -------- | ----- | ---------- | ---------- |
| 1 噪 diri05 | 不剪枝   | 数据量   | 0.0      | 0.0   | $T$        | 1.0        |
| 2 噪        | 不剪枝   | 贡献评估 | 0.0      | 0.0   | $T$        | 0.7        |
| 3 噪 diri05 | 静态剪枝 | 数据量   | 0.8      | 0.0   | $T$        | 1.0        |
| 4 噪 diri05 | 静态剪枝 | 贡献评估 | 0.8      | 0.0   | $T$        | 0.7        |
| 5 噪 diri05 | 动态剪枝 | 数据量   | 0.8      |       |            | 1.0        |
| 6 噪 diri05 | 动态剪枝 | 贡献评估 | 0.8      |       |            | 0.7        |

| 实验组编号 | $\alpha$ | $p^0$ | $\Delta T$ | $\gamma^0$ |
| ---------- | -------- | ----- | ---------- | ---------- |
| 1          | 0.0      | 0.0   | $T$        | 1.0        |
| 2          | 0.0      | 0.0   | $T$        | 0.7        |
| 3          |          |       |            |            |

聚合算法

| 剪枝率         | 0.0  | 0.1   | 0.2  | 0.3   | 0.4  | 0.5   | 0.6  | 0.7   | 0.8  | 0.9   | 1.0      |
| -------------- | ---- | ----- | ---- | ----- | ---- | ----- | ---- | ----- | ---- | ----- | -------- |
| 0.0            | 2    |       | 2    |       | 2    | 2     | 2    | 1     | 1    | 1     | 0.47538  |
| 0.8            |      | test1 |      | test2 |      | test4 |      | test5 |      | test6 | 0.532715 |
| noniid 0.5 0.9 |      | 0.56  |      | 0.57  |      | 0.56  |      | 0.58  |      | 0.56  | 0.57     |





### \subsection{初始调整比例系数$p^0$的影响}

\label{subsec:exp-pruning-2}

数据分布：iid 0.1 0.5

剪枝算法：是

剪枝率：0.5

动态剪枝：是

剪枝间隔：10

初始比例：0.0 0.1 0.3 0.5 0.7 0.9

聚合算法：是

权衡系数：1

统计指标：轮数

收敛速度：0.0最快

曲线稳定：0.0最稳定

最终精度：tradeoff

| 调整率 | 0.0           | 0.01    | 0.1               | 0.3                  | 0.5                 | 0.7               | 0.9               |
| ------ | ------------- | ------- | ----------------- | -------------------- | ------------------- | ----------------- | ----------------- |
| 0.1    | **0.52653** a | 0.44886 | 0.49334 - 0.49334 | **0.53636 x** - 0.54 | 0.47661 z - 0.53636 | 0.45227 - 0.47661 | 0.42387 - 0.45227 |
| 0.5    | **0.61985** a | 0.60639 | 0.62149           | 0.623909998 k        | 0.62862 x           | 0.62361           | 0.5961            |
| iid    | **0.66816** a | 0.66017 | 0.66177           | 0.65668              | 0.6482              | 0.64705           | 0.65354           |

| 调整率 | 0.0          | 0.1         | 0.3             | 0.5         | 0.7             | 0.9         |
| ------ | ------------ | ----------- | --------------- | ----------- | --------------- | ----------- |
| 0.5    | **0.52653**  | 0.49334     | 0.53636 x       | 0.47661 z   | 0.45227         | 0.42387     |
| 0.7    | **0.400715** | 0.38801     | 0.392505001     | 0.544505    | 0.392565002     | 0.355240002 |
| 0.9    | **0.33501**  | 0.332654999 | **0.302429999** | 0.370804998 | **0.308260001** | 0.349230003 |



### \subsection{动态调整间隔轮数$\Delta T$的影响}

\label{subsec:exp-pruning-3}

不剪枝 静态剪枝baseline

数据分布：iid 0.1 0.5

剪枝算法：是

剪枝率：0.5

动态剪枝：是

剪枝间隔：1 4 7 10 20 40

初始比例：0.5

聚合算法：是

权衡系数：1

统计指标：轮数

收敛速度：40最快

曲线稳定：40最稳定

最终精度：tradeoff

注意相同的超参数

| 调整间隔 | 0.0           | 1                   | 4                | 7             | 10                      | 20                | 40            |
| -------- | ------------- | ------------------- | ---------------- | ------------- | ----------------------- | ----------------- | ------------- |
| 0.1      | **0.52653** a | 0.38415 z           | 0.472735 x+z     | 0.47327 k     | 0.48978 x+z **0.53636** | 0.41252 z+j       | 0.51071 a     |
| 0.5      | **0.61985** a | **0.609295001** a+b | **0.620975** x+z | **0.63119** z | 0.61144 a+b **0.62862** | **0.613469988** a | **0.61186** a |
| iid      | **0.66816** a | 0.64863 a           |                  |               | 0.666059995 a           |                   |               |

| 调整间隔 | 0.0            | 1         | 4            | 7               | 10                      | 20              | 40          |
| -------- | -------------- | --------- | ------------ | --------------- | ----------------------- | --------------- | ----------- |
| 0.5      | **0.52653** a  | 0.38415 z | 0.472735 x+z | 0.47327 k       | 0.48978 x+z **0.53636** | 0.41252 z+j     | 0.51071 a   |
| 0.7      | **0.400715** a | 0.49285   | 0.495795     | **0.283890001** | 0.392505001             | **0.315755001** | 0.381395002 |
| 0.9      | **0.33501**    | 0.44025   | 0.376549999  | **0.307495001** | **0.302429999**         | **0.29852**     | 0.392675    |

| 0.5 - 0.52653 | 1                        | 4                            | 7                                      | 10                                         | 20                              | 40                | $\infin$    |
| ------------- | ------------------------ | ---------------------------- | -------------------------------------- | ------------------------------------------ | ------------------------------- | ----------------- | ----------- |
| 0.0           | 【0.52653】              | 【0.52653】                  | 【0.52653】                            | 【0.52653】                                | 【0.52653】                     | 【0.52653】       | 【0.52653】 |
| 0.1           |                          |                              |                                        | **0.39736** m                              |                                 |                   | 【0.52653】 |
| 0.3           |                          |                              | 0.43887 j **0.474075** k 0.428545003 l | **0.376555002** j                          | **0.414090002** j               |                   | 【0.52653】 |
| 0.4           | 0.191575 x 0.384894998 z | 0.463045 x **0.481304996** z | 0.403725001 x 0.16254 z                | 0.478740002 x 0.412959999 y **0.498885** z | 0.380689996 x **0.411975004** z | **0.511860001** x | 【0.52653】 |
| 0.5           |                          |                              |                                        | **0.384570004** m                          |                                 |                   | 【0.52653】 |
| 0.7           |                          |                              |                                        | **0.413295002** m                          |                                 |                   | 【0.52653】 |
| 0.9           |                          |                              |                                        | **0.141374998** m                          |                                 |                   | 【0.52653】 |

| 0.7 - 0.400715 | 1             | 4              | 7             | 10                | 20            | 40            | $\infin$     |
| -------------- | ------------- | -------------- | ------------- | ----------------- | ------------- | ------------- | ------------ |
| 0.0            | 【0.400715】  | 【0.400715】   | 【0.400715】  | 【0.400715】      | 【0.400715】  | 【0.400715】  | 【0.400715】 |
| 0.1            |               |                |               | **0.38801** m     |               |               | 【0.400715】 |
| 0.3            | **0.49285** m | **0.495795** m | 0.283890001 m | 0.392505001 m     | 0.315755001 m | 0.381395002 m | 【0.400715】 |
| 0.5            |               |                |               | **0.544505** m    |               |               | 【0.400715】 |
| 0.7            |               |                |               | **0.392565002** m |               |               | 【0.400715】 |
| 0.9            |               |                |               | **0.355240002** m |               |               | 【0.400715】 |

| 0.9 - 0.33501 | 1             | 4                 | 7             | 10            | 20          | 40          | $\infin$    |
| ------------- | ------------- | ----------------- | ------------- | ------------- | ----------- | ----------- | ----------- |
| 0.0           | 【0.33501】   | 【0.33501】       | 【0.33501】   | 【0.33501】   | 【0.33501】 | 【0.33501】 | 【0.33501】 |
| 0.1           |               |                   |               | 0.332654999 m |             |             | 【0.33501】 |
| 0.3           | **0.44025** m | **0.376549999** m | 0.307495001 m | 0.302429999 m | 0.29852 m   | 0.392675 m  | 【0.33501】 |
| 0.5           |               |                   |               | 0.370804998 m |             |             | 【0.33501】 |
| 0.7           |               |                   |               | 0.308260001 m |             |             | 【0.33501】 |
| 0.9           |               |                   |               | 0.349230003 m |             |             | 【0.33501】 |
